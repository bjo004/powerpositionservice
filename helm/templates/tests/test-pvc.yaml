apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "power-position-service.fullname" . }}-test-pvc"
  labels:
    {{- include "power-position-service.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  automountServiceAccountToken: false
  containers:
    - name: pvc-rw
      image: busybox:1.36
      command:
        - sh
        - -c
        - |
          set -e
          mkdir -p {{ .Values.powerPositionService.dataMountPath }}/helm-tests
          TS="$(date -u +%Y%m%dT%H%M%SZ)"
          FILE="{{ .Values.powerPositionService.dataMountPath }}/helm-tests/pvc_test_${TS}.txt"
          echo "hello-${TS}" > "${FILE}"
          sync
          test -f "${FILE}"
          grep "hello-${TS}" "${FILE}"
          echo "PVC read/write test passed: ${FILE}"
      volumeMounts:
        - name: data
          mountPath: {{ .Values.powerPositionService.dataMountPath }}
  volumes:
    - name: data
      persistentVolumeClaim:
        claimName: "data-{{ include "power-position-service.fullname" . }}-0"
